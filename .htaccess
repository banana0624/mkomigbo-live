# =========================================================
# public_html/.htaccess (CANONICAL CLEAN URLS + STATIC BYPASS)
# =========================================================

Options -Indexes -MultiViews
DirectoryIndex index.php

<IfModule mod_rewrite.c>
RewriteEngine On

# ---------------------------------------------------------
# 0) STATIC BYPASS (CRITICAL)
#    If the request is for a real file/dir, serve it directly.
# ---------------------------------------------------------
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# ---------------------------------------------------------
# Diagnostic endpoint
# ---------------------------------------------------------
RewriteRule ^rewrite-test$ rewrite-test.php [L]

# ---------------------------------------------------------
# 1) Home
# ---------------------------------------------------------
RewriteRule ^$ public/index.php [L,QSA]

# ---------------------------------------------------------
# 2) Subjects (Canonical clean URLs)
#
# Canonical:
#   /subjects/                  -> index
#   /subjects/{subject}/        -> subject controller
#   /subjects/{subject}/{page}/ -> page controller
#
# Redirect legacy/controller URLs to canonical.
# ---------------------------------------------------------

# 2a) Index
RewriteRule ^subjects/?$ public/subjects/index.php [L,QSA]

# 2b) Redirect direct controller access to canonical (prevents duplicates)
# /subjects/subject.php?slug=history  -> /subjects/history/
RewriteCond %{THE_REQUEST} \s/+subjects/subject\.php\?slug=([a-z0-9][a-z0-9_-]{0,190}) [NC]
RewriteRule ^subjects/subject\.php$ /subjects/%1/ [R=301,L]

# /subjects/page.php?subject=history&slug=intro -> /subjects/history/intro/
RewriteCond %{THE_REQUEST} \s/+subjects/page\.php\?subject=([a-z0-9][a-z0-9_-]{0,190})\&slug=([a-z0-9][a-z0-9_-]{0,190}) [NC]
RewriteRule ^subjects/page\.php$ /subjects/%1/%2/ [R=301,L]

# legacy: ?page= instead of ?slug=
RewriteCond %{THE_REQUEST} \s/+subjects/page\.php\?subject=([a-z0-9][a-z0-9_-]{0,190})\&page=([a-z0-9][a-z0-9_-]{0,190}) [NC]
RewriteRule ^subjects/page\.php$ /subjects/%1/%2/ [R=301,L]

# 2c) Canonical routing (pretty URLs -> real PHP files)
# Page: /subjects/{subject}/{page}/
RewriteRule ^subjects/([a-z0-9][a-z0-9_-]{0,190})/([a-z0-9][a-z0-9_-]{0,190})/?$ public/subjects/page.php?subject=$1&slug=$2 [L,QSA]

# Subject: /subjects/{subject}/
RewriteRule ^subjects/([a-z0-9][a-z0-9_-]{0,190})/?$ public/subjects/subject.php?slug=$1 [L,QSA]

# 2d) Allow any real file under /public/subjects/ (health/diag/scripts, etc.)
RewriteRule ^subjects/(.*)$ public/subjects/$1 [L,NC,QSA]

# ---------------------------------------------------------
# 3) Other modules (route into /public/<module>/...)
# ---------------------------------------------------------
RewriteRule ^contributors/?(.*)$   public/contributors/$1   [L,NC,QSA]
RewriteRule ^platforms/?(.*)$      public/platforms/$1      [L,NC,QSA]
RewriteRule ^staff/?(.*)$          public/staff/$1          [L,NC,QSA]
RewriteRule ^igbo-calendar/?(.*)$  public/igbo-calendar/$1  [L,NC,QSA]

# ---------------------------------------------------------
# 4) Final fallback
# ---------------------------------------------------------
RewriteRule ^ public/index.php [L,QSA]

</IfModule>

ErrorDocument 404 /404.shtml
